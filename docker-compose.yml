services:
  nginx:
    image: nginx:1.25-alpine
    container_name: rag-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - neo4j
      - graphiti
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  neo4j:
    image: neo4j:5.15-community
    container_name: rag-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-changeme123}
      - NEO4J_server_default__listen__address=0.0.0.0
      - NEO4J_server_default__advertised__address=localhost
      - NEO4J_server_bolt_advertised__address=localhost:7687
      - NEO4J_server_http_advertised__address=localhost:7474
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G
      - NEO4J_PLUGINS=["apoc","graph-data-science"]
      - NEO4J_server_config_strict__validation_enabled=false
      - NEO4J_server_db_query__cache__size=0
      - NEO4J_server_tx__log__rotation__retention__policy=100G size
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
      - ./neo4j/plugins:/var/lib/neo4j/plugins
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USERNAME:-neo4j}", "-p", "${NEO4J_PASSWORD:-changeme123}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  graphiti:
    image: graphiti-community-fix:latest
    container_name: rag-graphiti
    ports:
      - "8000:8000"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - neo4j_user=${NEO4J_USERNAME:-neo4j}
      - neo4j_password=${NEO4J_PASSWORD:-changeme123}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GRAPHITI_HOST=0.0.0.0
      - GRAPHITI_PORT=8000
      - GRAPHITI_LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - graphiti-data:/app/data
      - ./graphiti/config:/app/config
      - ./logs/graphiti:/app/logs
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/healthcheck').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  neo4j-import:
    driver: local
  neo4j-plugins:
    driver: local
  graphiti-data:
    driver: local

networks:
  rag-network:
    driver: bridge
    name: rag-network